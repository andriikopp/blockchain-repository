<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <title>Distributed Business Process Model Repository</title>
</head>

<body class="mt-4 mb-4 ml-4 mr-4">
    <h1>Distributed Business Process Model Repository</h1>

    <div class="list-group" id="models-list">
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js" integrity="sha512-nOQuvD9nKirvxDdvQ9OMqe2dgapbPB7vYAMrzJihw5m+aNcf0dX53m6YxM4LgA9u8e9eg9QX+/+mPu8kCNpV2A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js"></script>

    <script>
        // Contract address
        const contractAddress = '0x3fb05e46308064211c5dc968f437f308b5bb6a45';
        const contractABI = JSON.parse(`[
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_Title",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_Link",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_Hash",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_Annotation",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_Industry",
				"type": "string"
			}
		],
		"name": "AddModel",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "CheckMyPermission",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_User",
				"type": "address"
			}
		],
		"name": "CheckPermission",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "GetModelsCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_User",
				"type": "address"
			}
		],
		"name": "GivePermission",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "ReadModels",
		"outputs": [
			{
				"components": [
					{
						"internalType": "string",
						"name": "Title",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "Link",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "Hash",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "Annotation",
						"type": "string"
					},
					{
						"internalType": "string",
						"name": "Industry",
						"type": "string"
					},
					{
						"internalType": "uint256",
						"name": "DateTime",
						"type": "uint256"
					}
				],
				"internalType": "struct ModelsCollection.ModelRecord[]",
				"name": "",
				"type": "tuple[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_User",
				"type": "address"
			}
		],
		"name": "RevokePermission",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_User",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "_Permission",
				"type": "bool"
			}
		],
		"name": "SetPermission",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	}
]`);

        const infuraProvider = "https://ropsten.infura.io/v3/f9079a1b198f42369bf79d33e70a5eba";

        $(document).ready(function() {
            try {
                const web3 = new Web3(new Web3.providers.HttpProvider(infuraProvider));
                const contract = new web3.eth.Contract(contractABI, contractAddress);

                contract.methods.ReadModels().call().then(data => {
                    for (let i = 0; i < data.length; i++) {
                        const givenHash = data[i][2];
                        const actualHash = CryptoJS.SHA256($.ajax({
                            type: this.GET_REQUEST,
                            url: data[i][1],
                            async: false
                        }).responseText).toString();

                        console.log(data[i], actualHash);

                        $('#models-list').append(`<span class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${data[i][0]}</h5>
                                <small><a href="${data[i][1]}" target="_blank">BPMN File</a></small>
                            </div>
                            
                            ${givenHash === actualHash ? '<span class="badge badge-pill badge-success">Authentic</span>' : '<span class="badge badge-pill badge-danger">Tampered</span>'}

                            <p class="mb-1">${data[i][3]}</p>

                            <small>${data[i][4]}</small>
                        </span>`);
                    }
                });
            } catch (err) {
                alert(err.message);
            }
        });
    </script>
</body>

</html>